<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>광주광역시 · 전라남도 조례 비교검색</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0c0f14;
    --bg-secondary: #141820;
    --bg-card: #1a1f2b;
    --bg-card-hover: #1f2537;
    --border: #2a3040;
    --border-accent: #3a4560;
    --text-primary: #e8ecf4;
    --text-secondary: #8b95a8;
    --text-muted: #5c6577;
    --accent-gj: #4a9eff;
    --accent-gj-dim: rgba(74,158,255,.12);
    --accent-jn: #7c6aff;
    --accent-jn-dim: rgba(124,106,255,.12);
    --highlight: #3b8bff;
    --highlight-bg: rgba(59,139,255,.22);
    --danger: #ff6b6b;
    --success: #4ecdc4;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family:'Pretendard Variable',-apple-system,sans-serif;
    background:var(--bg-primary);color:var(--text-primary);
    min-height:100vh;overflow-x:hidden;
  }
  body::before{
    content:'';position:fixed;inset:0;
    background:
      radial-gradient(ellipse 80% 50% at 20% 0%,rgba(74,158,255,.06) 0%,transparent 60%),
      radial-gradient(ellipse 80% 50% at 80% 0%,rgba(124,106,255,.06) 0%,transparent 60%);
    pointer-events:none;z-index:0;
  }
  .app{position:relative;z-index:1}

  /* ── Header ── */
  .header{padding:32px 40px 0;text-align:center}
  .header-badge{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 14px;background:rgba(74,158,255,.08);
    border:1px solid rgba(74,158,255,.15);border-radius:20px;
    font-size:11px;font-weight:500;color:var(--accent-gj);
    letter-spacing:.5px;text-transform:uppercase;margin-bottom:16px;
  }
  .header-badge svg{width:14px;height:14px}
  .header h1{
    font-size:28px;font-weight:700;letter-spacing:-.5px;
    background:linear-gradient(135deg,var(--accent-gj),var(--accent-jn));
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    margin-bottom:6px;
  }
  .header p{font-size:13px;color:var(--text-muted)}

  /* ── Search ── */
  .search-section{padding:24px 40px;max-width:820px;margin:0 auto}
  .oc-row{
    display:flex;align-items:center;gap:8px;
    margin-bottom:14px;justify-content:center;flex-wrap:wrap;
  }
  .oc-row label{font-size:12px;color:var(--text-secondary);font-weight:500}
  .oc-input{
    width:220px;padding:8px 14px;background:var(--bg-card);
    border:1px solid var(--border);border-radius:8px;
    color:var(--text-primary);font-size:13px;font-family:inherit;
    transition:border-color .2s;
  }
  .oc-input:focus{outline:none;border-color:var(--accent-gj)}
  .oc-input::placeholder{color:var(--text-muted)}
  .oc-save{
    font-size:11px;color:var(--text-muted);display:flex;
    align-items:center;gap:4px;cursor:pointer;user-select:none;
  }
  .oc-save input{accent-color:var(--accent-gj)}

  .search-box{display:flex;gap:10px}
  .search-input-wrap{flex:1;position:relative}
  .search-input-wrap svg{
    position:absolute;left:16px;top:50%;transform:translateY(-50%);
    width:18px;height:18px;color:var(--text-muted);pointer-events:none;
  }
  .search-input{
    width:100%;padding:14px 16px 14px 44px;background:var(--bg-card);
    border:1px solid var(--border);border-radius:12px;
    color:var(--text-primary);font-size:15px;font-family:inherit;
    transition:all .25s;
  }
  .search-input:focus{
    outline:none;border-color:var(--accent-gj);
    box-shadow:0 0 0 3px rgba(74,158,255,.1);
  }
  .search-input::placeholder{color:var(--text-muted)}

  .search-btn{
    padding:14px 28px;
    background:linear-gradient(135deg,var(--accent-gj),var(--accent-jn));
    border:none;border-radius:12px;color:#fff;font-size:14px;
    font-weight:600;font-family:inherit;cursor:pointer;
    transition:all .25s;white-space:nowrap;
  }
  .search-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(74,158,255,.3)}
  .search-btn:active{transform:translateY(0)}
  .search-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}

  /* ── Notice ── */
  .notice{
    max-width:720px;margin:10px auto 0;padding:10px 16px;
    background:rgba(78,205,196,.07);border:1px solid rgba(78,205,196,.18);
    border-radius:10px;font-size:11.5px;color:var(--success);
    line-height:1.6;text-align:center;
  }
  .notice.error{
    background:rgba(255,107,107,.07);border-color:rgba(255,107,107,.18);
    color:var(--danger);display:none;
  }
  .notice.error.show{display:block}

  /* ── Status ── */
  .status-bar{
    display:flex;justify-content:center;gap:24px;
    padding:14px 40px;font-size:11.5px;color:var(--text-muted);
  }
  .status-item{display:flex;align-items:center;gap:6px}
  .status-dot{width:6px;height:6px;border-radius:50%;background:var(--text-muted)}
  .status-dot.ok{background:var(--success)}
  .status-dot.loading{background:#f0ad4e;animation:pulse 1s infinite}
  .status-dot.error{background:var(--danger)}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

  /* ── Panels ── */
  .content{
    display:grid;grid-template-columns:1fr 1fr;gap:16px;
    padding:0 24px 48px;min-height:55vh;
  }
  .panel{
    background:var(--bg-secondary);border-radius:16px;
    overflow:hidden;display:flex;flex-direction:column;
  }
  .panel-header{
    padding:16px 22px;border-bottom:1px solid var(--border);
    display:flex;align-items:center;justify-content:space-between;
    flex-shrink:0;
  }
  .panel-title{display:flex;align-items:center;gap:10px}
  .panel-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
  .panel-dot.gj{background:var(--accent-gj);box-shadow:0 0 8px rgba(74,158,255,.4)}
  .panel-dot.jn{background:var(--accent-jn);box-shadow:0 0 8px rgba(124,106,255,.4)}
  .panel-title h2{font-size:15px;font-weight:600;letter-spacing:-.3px}
  .panel-count{
    font-size:12px;color:var(--text-muted);font-weight:500;
    padding:4px 10px;background:var(--bg-card);border-radius:8px;
  }
  .panel-body{flex:1;overflow-y:auto;padding:14px}
  .panel-body::-webkit-scrollbar{width:5px}
  .panel-body::-webkit-scrollbar-track{background:transparent}
  .panel-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

  /* ── Cards ── */
  .card{
    background:var(--bg-card);border:1px solid var(--border);
    border-radius:12px;margin-bottom:10px;transition:all .2s;cursor:pointer;
  }
  .card:hover{border-color:var(--border-accent);background:var(--bg-card-hover)}
  .card.open{border-color:var(--accent-gj)}
  .panel:last-child .card.open{border-color:var(--accent-jn)}
  .card-head{
    padding:13px 16px;display:flex;align-items:flex-start;
    justify-content:space-between;gap:10px;
  }
  .card-name{font-size:13.5px;font-weight:600;line-height:1.5;flex:1}
  .card-tag{
    font-size:10.5px;padding:3px 8px;border-radius:6px;
    font-weight:500;white-space:nowrap;flex-shrink:0;
  }
  .panel:first-child .card-tag{background:var(--accent-gj-dim);color:var(--accent-gj)}
  .panel:last-child  .card-tag{background:var(--accent-jn-dim);color:var(--accent-jn)}

  .card-body{padding:0 16px 14px;display:none}
  .card.open .card-body{display:block}

  .article{
    padding:9px 0;border-bottom:1px solid rgba(42,48,64,.5);
    font-size:12.8px;line-height:1.8;color:var(--text-secondary);
  }
  .article:last-child{border-bottom:none}
  .article-title{font-weight:600;color:var(--text-primary);margin-bottom:3px;font-size:12.8px}
  .article-body{white-space:pre-wrap;word-break:break-all}

  .kw{
    color:var(--highlight)!important;background:var(--highlight-bg);
    padding:1px 3px;border-radius:3px;font-weight:600;
  }

  /* ── States ── */
  .loading-box{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;gap:14px}
  .spinner{
    width:28px;height:28px;border:3px solid var(--border);
    border-top-color:var(--accent-gj);border-radius:50%;
    animation:spin .8s linear infinite;
  }
  .panel:last-child .spinner{border-top-color:var(--accent-jn)}
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading-text{font-size:12.5px;color:var(--text-muted)}

  .empty{
    display:flex;flex-direction:column;align-items:center;
    justify-content:center;padding:70px 28px;text-align:center;
  }
  .empty svg{width:44px;height:44px;color:var(--text-muted);margin-bottom:14px;opacity:.35}
  .empty h3{font-size:14px;font-weight:600;color:var(--text-secondary);margin-bottom:5px}
  .empty p{font-size:12px;color:var(--text-muted);line-height:1.6}

  .err-box{padding:24px;text-align:center}
  .err-box p{font-size:12.5px;color:var(--danger);line-height:1.7}

  /* ── Footer ── */
  .footer{
    text-align:center;padding:0 24px 32px;font-size:11px;color:var(--text-muted);
    line-height:1.7;
  }
  .footer a{color:var(--accent-gj);text-decoration:none}
  .footer a:hover{text-decoration:underline}

  /* ── Responsive ── */
  @media(max-width:900px){
    .content{grid-template-columns:1fr;padding:0 14px 40px}
    .header{padding:24px 18px 0}
    .header h1{font-size:22px}
    .search-section{padding:20px 16px}
    .search-box{flex-direction:column}
    .search-btn{padding:12px}
  }
</style>
</head>
<body>
<div class="app" id="app">

  <header class="header">
    <div class="header-badge">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
      법제처 OPEN API
    </div>
    <h1>조례 비교검색</h1>
    <p>광주광역시 · 전라남도 자치법규를 나란히 비교합니다</p>
  </header>

  <section class="search-section">
    <div class="search-box">
      <div class="search-input-wrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <input type="text" id="keyword" class="search-input" placeholder="검색 키워드를 입력하세요 (예: 장애인, 환경, 교육 …)">
      </div>
      <button class="search-btn" id="btn" onclick="doSearch()">검색</button>
    </div>
    <div class="notice error" id="err-notice"></div>
  </section>

  <div class="status-bar">
    <div class="status-item"><div class="status-dot" id="sd-gj"></div><span id="st-gj">광주광역시 대기중</span></div>
    <div class="status-item"><div class="status-dot" id="sd-jn"></div><span id="st-jn">전라남도 대기중</span></div>
  </div>

  <main class="content">
    <div class="panel" id="panel-gj">
      <div class="panel-header">
        <div class="panel-title"><div class="panel-dot gj"></div><h2>광주광역시 조례</h2></div>
        <span class="panel-count" id="cnt-gj">0건</span>
      </div>
      <div class="panel-body" id="body-gj">
        <div class="empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="M8 7h6"/><path d="M8 11h8"/></svg>
          <h3>검색어를 입력하세요</h3>
          <p>광주광역시 조례를 검색합니다.</p>
        </div>
      </div>
    </div>
    <div class="panel" id="panel-jn">
      <div class="panel-header">
        <div class="panel-title"><div class="panel-dot jn"></div><h2>전라남도 조례</h2></div>
        <span class="panel-count" id="cnt-jn">0건</span>
      </div>
      <div class="panel-body" id="body-jn">
        <div class="empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="M8 7h6"/><path d="M8 11h8"/></svg>
          <h3>검색어를 입력하세요</h3>
          <p>전라남도 조례를 검색합니다.</p>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    데이터 출처: <a href="https://open.law.go.kr" target="_blank">법제처 국가법령정보 공동활용</a>
  </footer>
</div>

<script>
const WORKER = 'https://law-proxy.kyungsamko.workers.dev';
const OC     = 'kyungsamko';
const SEARCH = 'http://www.law.go.kr/DRF/lawSearch.do';
const DETAIL = 'http://www.law.go.kr/DRF/lawService.do';

let KW = '';
const detailCache = {};

const $ = id => document.getElementById(id);
const xmlParse = txt => new DOMParser().parseFromString(txt,'text/xml');

function hl(text, kw){
  if(!kw||!text) return text||'';
  const esc = kw.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  return text.replace(new RegExp(`(${esc})`,'gi'),'<span class="kw">$1</span>');
}

function setStatus(r, cls, msg){
  $(`sd-${r}`).className = 'status-dot ' + cls;
  $(`st-${r}`).textContent = msg;
}

async function apiFetch(baseUrl, params){
  const qs = new URLSearchParams(params).toString();
  const raw = `${baseUrl}?${qs}`;
  const url = `${WORKER}/?url=${encodeURIComponent(raw)}`;

  const ac = new AbortController();
  const t = setTimeout(() => ac.abort(), 15000);
  try {
    const res = await fetch(url, { signal: ac.signal });
    clearTimeout(t);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    if(!text || text.length < 20) throw new Error('빈 응답');
    return xmlParse(text);
  } catch(e){
    clearTimeout(t);
    if(e.name === 'AbortError') throw new Error('시간 초과');
    throw e;
  }
}

/* ── 조례 목록 검색 ── */
async function fetchList(keyword, region){
  const org = region === 'gj' ? '광주광역시' : '전라남도';
  return apiFetch(SEARCH, {
    OC, target:'ordin', type:'XML',
    query: keyword, display:'20', org
  });
}

/* ── 조례 본문 조회 ── */
async function fetchDetail(id){
  if(detailCache[id]) return detailCache[id];
  const xml = await apiFetch(DETAIL, {
    OC, target:'ordin', type:'XML', ID: id
  });
  detailCache[id] = xml;
  return xml;
}

/* ── 본문에서 조문 파싱 ── */
function parseArticles(xml){
  const arts = [];
  const trySelectors = ['조문단위','조문'];
  for(const sel of trySelectors){
    xml.querySelectorAll(sel).forEach(n => {
      const t = n.querySelector('조문제목')?.textContent || '';
      const c = n.querySelector('조문내용')?.textContent || '';
      if(c) arts.push({title:t, content:c});
    });
    if(arts.length) break;
  }
  return arts;
}

/* ── 목록 XML → items ── */
function parseList(xml){
  const items = [];
  // 다양한 XML 구조에 대응
  const candidates = ['ordin','자치법규','law'];
  let nodes = null;
  for(const tag of candidates){
    const found = xml.querySelectorAll(tag);
    if(found.length){ nodes = found; break; }
  }
  // fallback: totalCnt 외 자식 탐색
  if(!nodes || !nodes.length){
    const root = xml.documentElement;
    if(root){
      for(const child of root.children){
        if(['totalCnt','page','resultCnt'].includes(child.tagName)) continue;
        const nm = child.querySelector('자치법규명,법규명,ordinName,법령명칭');
        if(nm){ nodes = xml.querySelectorAll(child.tagName); break; }
      }
    }
  }
  if(!nodes) return items;

  nodes.forEach(n => {
    const name = (n.querySelector('자치법규명')||n.querySelector('법규명')||n.querySelector('ordinName')||n.querySelector('법령명칭'))?.textContent || '';
    const id   = (n.querySelector('자치법규ID')||n.querySelector('자치법규일련번호')||n.querySelector('ordinId')||n.querySelector('법규ID'))?.textContent || '';
    const type = (n.querySelector('자치법규종류')||n.querySelector('법규종류'))?.textContent || '조례';
    if(name) items.push({name, id, type});
  });
  return items;
}

/* ── 카드 토글 ── */
async function toggleCard(region, idx, ordinId){
  const card = $(`c-${region}-${idx}`);
  const body = $(`cb-${region}-${idx}`);

  if(card.classList.contains('open')){
    card.classList.remove('open');
    return;
  }
  card.classList.add('open');
  if(body.dataset.loaded === '1') return;

  body.innerHTML = `<div class="loading-box" style="padding:18px"><div class="spinner" style="width:20px;height:20px;border-width:2px"></div><div class="loading-text" style="font-size:11.5px">본문 불러오는 중…</div></div>`;

  try {
    const xml = await fetchDetail(ordinId);
    const arts = parseArticles(xml);

    if(arts.length){
      body.innerHTML = arts.map(a => `
        <div class="article">
          ${a.title ? `<div class="article-title">${hl(a.title, KW)}</div>` : ''}
          <div class="article-body">${hl(a.content, KW)}</div>
        </div>`).join('');
    } else {
      // fallback: 전체 텍스트
      const raw = xml.documentElement?.textContent?.trim() || '';
      if(raw.length > 30){
        body.innerHTML = `<div class="article"><div class="article-body">${hl(raw.substring(0,5000), KW)}</div></div>`;
      } else {
        body.innerHTML = '<div class="err-box"><p style="color:var(--text-muted)">본문 내용을 불러올 수 없습니다.</p></div>';
      }
    }
    body.dataset.loaded = '1';
  } catch(e){
    body.innerHTML = `<div class="err-box"><p>본문 조회 실패: ${e.message}</p></div>`;
  }
}

/* ── 결과 렌더링 ── */
function render(region, items){
  const body = $(`body-${region}`);
  const cnt  = $(`cnt-${region}`);
  cnt.textContent = `${items.length}건`;

  if(!items.length){
    body.innerHTML = `<div class="empty">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      <h3>검색 결과가 없습니다</h3><p>다른 키워드로 검색해 보세요.</p></div>`;
    return;
  }

  body.innerHTML = items.map((it, i) => `
    <div class="card" id="c-${region}-${i}" onclick="toggleCard('${region}',${i},'${it.id}')">
      <div class="card-head">
        <div class="card-name">${hl(it.name, KW)}</div>
        <span class="card-tag">${it.type||'조례'}</span>
      </div>
      <div class="card-body" id="cb-${region}-${i}"></div>
    </div>`).join('');
}

/* ── 메인 검색 ── */
async function doSearch(){
  const keyword = $('keyword').value.trim();
  const errBox = $('err-notice');
  errBox.classList.remove('show');

  if(!keyword){
    alert('검색 키워드를 입력해주세요.');
    $('keyword').focus(); return;
  }

  KW = keyword;
  $('btn').disabled = true;
  $('btn').textContent = '검색중…';

  for(const r of ['gj','jn']){
    $(`body-${r}`).innerHTML = `<div class="loading-box"><div class="spinner"></div><div class="loading-text">조례를 검색하고 있습니다…</div></div>`;
    setStatus(r,'loading',(r==='gj'?'광주광역시':'전라남도')+' 검색중…');
  }

  const search = async r => {
    const label = r==='gj'?'광주광역시':'전라남도';
    try {
      const xml = await fetchList(keyword, r);
      const err = xml.querySelector('error,Error');
      if(err) throw new Error(err.textContent||'API 오류');

      const items = parseList(xml);
      render(r, items);
      setStatus(r, items.length?'ok':'', `${label} ${items.length}건`);
    } catch(e){
      console.error(`[${r}]`, e);
      if(e.message.includes('Failed to fetch') || e.message.includes('NetworkError') || e.message.includes('시간 초과')){
        $(`body-${r}`).innerHTML = `<div class="err-box"><p>프록시 연결 실패<br><span style="font-size:11px;color:var(--text-muted)">${e.message}</span></p></div>`;
        errBox.textContent = '⚠ Workers 프록시 연결 실패';
        errBox.classList.add('show');
      } else {
        $(`body-${r}`).innerHTML = `<div class="err-box"><p>검색 실패: ${e.message}</p></div>`;
      }
      setStatus(r,'error',`${label} 오류`);
    }
  };

  await Promise.all(['gj','jn'].map(search));
  $('btn').disabled = false;
  $('btn').textContent = '검색';
}

/* ── 단축키 ── */
$('keyword').addEventListener('keydown', e => { if(e.key==='Enter') doSearch(); });
</script>
</body>
</html>
